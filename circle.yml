machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker build --no-cache -t htmlgraphic/apache:$CIRCLE_BRANCH .
    - sudo pip install docker-compose

test:
  override:
    # stop MySQL from running on CircleCI
    - sudo service mysql stop

    # spin up containers simulating a LOCAL / DEV build
    - make run; sleep 2
    - wget -q -O- http://127.0.0.1 | grep -w "dev"
    - wget -q -O- --no-check-certificate https://127.0.0.1 | grep -w "dev"
    - sudo lxc-attach -n "$(docker inspect --format '{{.Id}}' apache_web_1)" -- bash -c /opt/tests/build_tests.sh

    - docker logs apache_web_1 > log_output
    - mv log_output $CIRCLE_ARTIFACTS/log_output.txt
    - make rm; sleep 2

    # spin up containers simulating a LIVE / PRODUCTION build
    - docker-compose up -d; sleep 2
    - wget -q -O- http://127.0.0.1 | grep -w "production"
    - wget -q -O- --no-check-certificate https://127.0.0.1 | grep -w "production"
    - docker ps -a
